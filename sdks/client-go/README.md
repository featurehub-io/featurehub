client-go
=========

A GoLang client SDK for FeatureHub.

Features
--------
* Client interface, with an autogenerated mock so you can unit test with this SDK
* Config type, with validation and defaults
* StreamingClient implementation:
    - Features are made available through "Get" methods:
        - `GetFeature` returns a whole feature (by key) with full metadata (but an untyped value)
        - `GetBoolean` returns a boolean feature (by key), or an error if it is unable to assert the value to a boolean
        - `GetNumber` / `GetRawJSON` / `GetString` as above
    - Levelled Logging (you can choose how verbose to make this)
	- Notifiers can be added for named feature keys, which will trigger a user-provided callback function whenever a feature with this key is updated
	- Notifiers can be added ahead of time (before the client even knows about the feature-keys in question)
* Custom errors (allows you to handle different errors in specific ways)


Usage
-----
Some snippets to get you going.

### Connecting to FeatureHub
There are 3 steps to connecting:
1) Prepare a config
2) Use the config to make a client
3) Tell the client to start handling features

#### Prepare a configuration:
```go
    config := &client.Config{
        SDKKey:        "default/aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee/ajhsgdJHGAFKJAHSGDFKAJHHSDLFKAJLSKJDHFLAJKHlkjahlkjhfsld",
        ServerAddress: "http://1.2.3.4:8085",
		WaitForData:   true,
    }
```

#### Use it to make a new client:
```go
	fhClient, err := client.NewStreamingClient(config)
	if err != nil {
		log.Fatalf("Error connecting to FeatureHub: %s", err)
    }
```

#### Start handling data (will block until some data is received if `config.WaitForData` is set):
```go
    fhClient.Start()
```


### Requesting Features
The client SDK offers various `Get` methods to retrieve different types of features:
* `GetBoolean(key)`: returns a true or false
* `GetRawJSON(key)`: returns a serialised JSON object
* `GetNumber(key)`: returns a float64
* `GetString(key)`: returns a string

#### Retrieve a BOOLEAN value:
```go
	someBoolean, err := fhClient.GetBoolean("booleanfeature")
	if err != nil {
		log.Fatalf("Error retrieving a BOOLEAN feature: %s", err)
	}
	log.Printf("Retrieved a BOOLEAN feature: %v", someBoolean)
```

#### Retrieve a JSON value:
```go
	someJSON, err := fhClient.GetRawJSON("jsonfeature")
	if err != nil {
		log.Fatalf("Error retrieving a JSON feature: %s", err)
	}
	log.Printf("Retrieved a JSON feature: %s", someJSON)
```

#### Retrieve a NUMBER value:
```go
	someNumber, err := fhClient.GetNumber("numberfeature")
	if err != nil {
		log.Fatalf("Error retrieving a NUMBER feature: %s", err)
	}
	log.Printf("Retrieved a NUMBER feature: %f", someNumber)
```

#### Retrieve a STRING value:
```go
	someString, err := fhClient.GetString("stringfeature")
	if err != nil {
		log.Fatalf("Error retrieving a STRING feature: %s", err)
	}
    log.Printf("Retrieved a STRING feature: %s", someString)
```


### Configuring Notifiers (callbacks)
The client SDK allows the user to define callback notifications which will be triggered whenever a specific feature key is updated.
Notifiers can be defined at any time, even before the client has received data.
* `AddNotifierBoolean(key string, callback func(bool))`: Calls the provided function with a boolean value
* `AddNotifierFeature(key string, callback func(*models.FeatureState))`: Calls the provided function with a raw feature state
* `AddNotifierJSON(key string, callback func(string))`: Calls the provided function with a JSON string value
* `AddNotifierNumber(key string, callback func(float64))`: Calls the provided function with a float64 value
* `AddNotifierString(key string, callback func(string))`: Calls the provided function with a string value
* `DeleteNotifier(key string) error`: Deletes any configured notifier for the given key (or returns an error if no notifier was found)


### Configuring a Readiness Listener
The client SDK allows the user to define a callback function which will be triggered once, when the client first receives some data from the server.
* `ReadinessListener(callback func())`: Sets the readiness listener to a specific user-provided function


### Analytics Collector
The client SDK provides the ability to generate analytics events with the `LogAnalyticsEvent` method. An event will be generated for each feature that we have.

```go
	action := "payment"
	tags := map[string]string{"user": "bob"}
	client.LogAnalyticsEvent(action, tags)
```
The SDK offers a logging analytics collector which will log events to the console at DEBUG level (useful in your unit tests probably).


#### Google Analytics
The GoLang SDK comes with a pre-made Google Analytics collector. Here is how to use it:

```go
	googleAnalyticsCollector, err := analytics.NewGoogleAnalyticsCollector(clientID, trackingID, userAgentKey)
	if err != nil {
		panic(err)
	}
	client.AddAnalyticsCollector(googleAnalyticsCollector)
```
Any subsequent calls to `client.LogAnalyticsEvent()` will result in events being sent via the Google Analytics collector (as well as any other which you have added).


### Client-side rollout strategies
Some rollout strategies need to be calculated per-request, which means that we can't rely on the server to do this for us. For this we provide the ability to apply a client context to a feature before using its value:

```go
	// Define your client context (rollout strategies will hash by Session, or Userkey if Session is unset):
	clientContext := &Context{
		Userkey:  "12345",
		Device:   "server",
		Platform: "linux",
		Country:  "russia",
		Version:  "1.0.5",
	}

	// First retrieve the value as a feature:
	featureValue, _ := fhClient.GetFeature("feature-key")

	// Then you can apply a client context and read your value as its specific type, with rollout strategies applied:
	numberValue, _ := featureValue.WithContext(clientContext).AsNumber()
```
If the featureValue has rollout strategies defined then they will be applied according to the client context you provide.



Todo
----
- [X] Config
- [X] Client interface
- [X] StreamingClient
- [X] Unit tests
- [X] Handle feature_delete events
- [X] Compare versions when "feature" event is received (don't just overwrite)
- [X] Allow notify / callback functions (add and remove)
- [X] Global "readyness" callback (either OK when data has arrived, or an error if there was a fail)
- [X] Analytics support
- [X] Google Analytics support
- [X] Removed support for server-side ClientContext, and submit this as an x-featurehub header upon connection
- [ ] Run tests and code-generation inside Docker (instead of requiring Go to be installed locally)
- [X] Client-side rollout strategies (https://github.com/featurehub-io/featurehub/tree/master/backend/sse-strategy-matchers/src)
	- [x] Percentages [==, !=]
	- [x] Country [==, !=]
	- [x] Device [==, !=]
	- [x] Platform [==, !=]
	- [x] Version [==, !=, >, >=, <, <=]
	- [ ] Custom
		- [ ] string
		- [ ] semver
		- [ ] number
		- [ ] date
		- [ ] date-time
		- [ ] boolean
		- [ ] ip-address

Strategy matching logic:
- If strategy has a percentage then hash on userkey or session and decide
- If the percentage doesn't match then continue with the next strategy
- If percentage matches (or there is no percentage) then continue and iterate through the attributes
	- If the attribute doesn't match then fall back and continue with the next strategy
	- If attribute matches then continue and check the next attribute
	- If all attributes match then we return the value from this strategy
	- Otherwise continue with the next strategy
- If no strategies match then return the default value for the feature
